webshim.register("filereader",function(e,t,o,a,n,r){"use strict";var i,s,l,p=e.noop,d='input[type="file"].ws-filereader',u=function(){t.loader.loadList(["moxie"])},f=function(){var o,a,n,r,s=this;t.implement(s,"filepicker")&&(s=this,o=e(this),n=o.parent(),r=function(){s.value||o.prop("value","")},o.attr("tabindex","-1").on("mousedown.filereaderwaiting click.filereaderwaiting",!1),n.addClass("ws-loading"),a=new i.FileInput({browse_button:this,accept:e.prop(this,"accept"),multiple:e.prop(this,"multiple")}),o.jProp("form").on("reset",function(){setTimeout(r)}),a.onready=function(){o.off(".fileraderwaiting"),n.removeClass("ws-waiting")},a.onchange=function(e){t.data(s,"fileList",e.target.files),o.trigger("change")},a.onmouseenter=function(){o.trigger("mouseover"),n.addClass("ws-mouseenter")},a.onmouseleave=function(){o.trigger("mouseout"),n.removeClass("ws-mouseenter")},a.onmousedown=function(){o.trigger("mousedown"),n.addClass("ws-active")},a.onmouseup=function(){o.trigger("mouseup"),n.removeClass("ws-active")},t.data(s,"filePicker",a),t.ready("WINDOWLOAD",function(){var e;o.onWSOff("updateshadowdom",function(){var t=s.offsetWidth;t&&e!=t&&(e=t,a.refresh())})}),t.addShadowDom(),a.init(),s.disabled&&a.disable(!0))},m=function(e){return e.name},c=function(){var o=this;u(),e(o).on("mousedown.filereaderwaiting click.filereaderwaiting",!1).parent().addClass("ws-loading"),t.ready("moxie",function(){c.call(o)})},h=/^(?:script|jsonp)$/i,x=function(){u(),t.error('filereader/formdata not ready yet. please wait for moxie to load `webshim.ready("moxie", callbackFn);`` or wait for the first change event on input[type="file"].ws-filereader.')},y=t.defineNodeNameProperty("input","value",{prop:{get:function(){var e=t.data(this,"fileList");return e&&e.map?e.map(m).join(", "):y.prop._supget.call(this)}}}),g=t.cfg.basePath+"moxie/",w='You nedd a crossdomain.xml to get all "filereader" / "XHR2" / "CORS" features to work. Or host moxie.swf/moxie.xap on your server an configure filereader options: "swfpath"/"xappath"',v=function(t){return"moxie"==t.wsType||t.data&&t.data instanceof i.FormData||t.crossDomain&&e.support.cors!==!1&&"no"!=l&&!h.test(t.dataType||"")},b=function(o){if(v(o)){var a;return t.info("moxie transfer used for $.ajax"),"no"==l&&t.error(w),{send:function(t,n){var i=function(e,t){if(o[t]){var n=!1;a.addEventListener("load",function(){n?n.lengthComputable&&n.total>n.loaded&&o[t]({type:"progress",lengthComputable:!0,total:n.total,loaded:n.total}):o[t]({type:"progress",lengthComputable:!0,total:1,loaded:1})}),e.addEventListener("progress",function(e){n=e,o[t](e)})}};a=new s.xhr.XMLHttpRequest,a.open(o.type,o.url,o.async,o.username,o.password),i(a.upload,r.uploadprogress),i(a.upload,r.progress),a.addEventListener("load",function(){var e={text:a.responseText,xml:a.responseXML};n(a.status,a.statusText,e,a.getAllResponseHeaders())}),o.xhrFields&&o.xhrFields.withCredentials&&(a.withCredentials=!0),o.timeout&&(a.timeout=o.timeout),e.each(t,function(e,t){a.setRequestHeader(e,t)}),a.send(o.data)},abort:function(){a&&a.abort()}}}},T={xdomain:function(){var o=/^https?:\/\//i,a=/^get|post$/i,n=new RegExp("^"+location.protocol,"i");return function(r,s){if(!(!r.crossDomain||r.username||r.xhrFields&&r.xhrFields.withCredentials||!r.async||!a.test(r.type)||!o.test(r.url)||!n.test(r.url)||r.data&&r.data instanceof i.FormData||h.test(r.dataType||""))){var l=null;return t.info("xdomain transport used."),{send:function(t,o){var a="",n=(s.dataType||"").toLowerCase();l=new XDomainRequest,/^\d+$/.test(s.timeout)&&(l.timeout=s.timeout),l.ontimeout=function(){o(500,"timeout")},l.onload=function(){var t="Content-Length: "+l.responseText.length+"\r\nContent-Type: "+l.contentType,a={code:l.status||200,message:l.statusText||"OK"},r={text:l.responseText,xml:l.responseXML};try{if("html"===n||/text\/html/i.test(l.contentType))r.html=l.responseText;else if("json"===n||"text"!==n&&/\/json/i.test(l.contentType))try{r.json=e.parseJSON(l.responseText)}catch(i){}else if("xml"===n&&!l.responseXML){var s;try{s=new ActiveXObject("Microsoft.XMLDOM"),s.async=!1,s.loadXML(l.responseText)}catch(i){}r.xml=s}}catch(p){}o(a.code,a.message,r,t)},l.onprogress=function(){},l.onerror=function(){o(500,"error",{text:l.responseText})},s.data&&(a="string"===e.type(s.data)?s.data:e.param(s.data)),l.open(r.type,r.url),l.send(a)},abort:function(){l&&l.abort()}}}}}(),moxie:function(e,o,a){if(v(e)){u(e);var n,r={send:function(i,s){n=!0,t.ready("moxie",function(){n&&(n=b(e,o,a),r.send=n.send,r.abort=n.abort,n.send(i,s))})},abort:function(){n=!1}};return r}}};r.progress||(r.progress="onprogress"),r.uploadprogress||(r.uploadprogress="onuploadprogress"),r.swfpath||(r.swfpath=g+"flash/Moxie.min.swf"),r.xappath||(r.xappath=g+"silverlight/Moxie.min.xap"),e.support.cors===!1&&o.XDomainRequest||delete T.xdomain,e.ajaxTransport("+*",function(e,t,o){var a,n;if((e.wsType||T[T])&&(a=T[T](e,t,o)),!a)for(n in T)if(a=T[n](e,t,o))break;return a}),t.defineNodeNameProperty("input","files",{prop:{writeable:!1,get:function(){return"file"!=this.type?null:(e(this).is(".ws-filereader")||t.info("please add the 'ws-filereader' class to your input[type='file'] to implement files-property"),t.data(this,"fileList")||[])}}}),t.reflectProperties(["input"],["accept"]),null==e("<input />").prop("multiple")&&t.defineNodeNamesBooleanProperty(["input"],["multiple"]),t.onNodeNamesPropertyModify("input","disabled",function(e,o){var a=t.data(this,"filePicker");a&&a.disable(o)}),t.onNodeNamesPropertyModify("input","value",function(o){""===o&&"file"==this.type&&e(this).hasClass("ws-filereader")&&t.data(this,"fileList",[])}),o.FileReader=x,o.FormData=x,t.ready("moxie",function(){var a="application/xml,xml";s=o.moxie,i=o.mOxie,i.Env.swf_url=r.swfpath,i.Env.xap_url=r.xappath,o.FileReader=i.FileReader,o.FormData=function(o){var a,n,r,s,l,p,d,u=new i.FormData;if(o&&e.nodeName(o,"form")){for(a=e(o).serializeArray(),n=0;n<a.length;n++)Array.isArray(a[n].value)?a[n].value.forEach(function(e){u.append(a[n].name,e)}):u.append(a[n].name,a[n].value);for(a=o.querySelectorAll('input[type="file"][name]'),n=0,r=a.length;n<a.length;n++)if(d=a[n].name,d&&!e(a[n]).is(":disabled")&&(s=e.prop(a[n],"files")||[],s.length))for((s.length>1||u.hasBlob&&u.hasBlob())&&t.error("FormData shim can only handle one file per ajax. Use multiple ajax request. One per file."),l=0,p=s.length;p>l;l++)u.append(d,s[l])}return u},p=o.FormData,c=f,T.moxie=b,r.mimeTypes=r.mimeTypes?a+","+r.mimeTypes:a;try{i.Mime.addMimeType(r.mimeTypes)}catch(n){t.warn("mimetype to moxie error: "+n)}}),t.addReady(function(t,o){e(t.querySelectorAll(d)).add(o.filter(d)).each(c)}),t.ready("WINDOWLOAD",u),t.cfg.debug!==!1&&r.swfpath.indexOf(location.protocol+"//"+location.hostname)&&r.swfpath.indexOf("https://"+location.hostname)&&t.ready("WINDOWLOAD",function(){var o=function(){"no"==l&&t.error(w)};try{l=sessionStorage.getItem("wsXdomain.xml")}catch(a){}o(),null==l&&e.ajax({url:"crossdomain.xml",type:"HEAD",dataType:"xml",success:function(){l="yes"},error:function(){l="no"},complete:function(){try{sessionStorage.setItem("wsXdomain.xml",l)}catch(e){}o()}})})});